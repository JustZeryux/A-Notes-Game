<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>A NOTE GAME</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700;900&display=swap');

        :root {
            --bg: #050505;
            --c0: #C24B99; --c1: #00FFFF; --c2: #12FA05; --c3: #F9393F;
            --gold: #FFD700; 
            --panel: rgba(10, 10, 10, 0.9);
            --border: 1px solid rgba(255,255,255,0.15);
        }

        body {
            margin: 0; background: #000;
            color: white; font-family: 'Chakra Petch', sans-serif;
            overflow: hidden; user-select: none; height: 100vh; width: 100vw;
            touch-action: none;
        }

        /* === CAPAS (LAYERS) === */
        #bg-layer { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 0; overflow: hidden; }
        #bg-video, #bg-image { width: 100%; height: 100%; object-fit: cover; opacity: 0.4; filter: brightness(0.5); position: absolute; top:0; left:0; }
        
        #game-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transition: transform 0.05s; z-index: 10; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 20; }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* === USER BAR === */
        #user-bar {
            position: fixed; top: 20px; left: 20px; z-index: 5000;
            display: flex; align-items: center; gap: 15px; 
            background: rgba(0,0,0,0.8); padding: 8px 20px 8px 8px; border-radius: 50px;
            border: 1px solid rgba(255,255,255,0.2); cursor: pointer; backdrop-filter: blur(10px);
            transition: 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #user-bar:hover { border-color: var(--c1); box-shadow: 0 0 20px var(--c1); transform: scale(1.05); }
        .avatar { width: 45px; height: 45px; background: linear-gradient(135deg, var(--c1), var(--c0)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 900; color: black; font-size: 1.4rem; border: 2px solid white; }
        .user-info { display: flex; flex-direction: column; }
        .user-name { font-size: 1rem; font-weight: bold; color: white; }
        .xp-track { width: 100px; height: 5px; background: #333; border-radius: 3px; margin-top: 3px; overflow: hidden; }
        .xp-fill { height: 100%; width: 0%; background: var(--c2); transition: width 0.5s ease-out; }

        /* === PANTALLAS === */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.92); backdrop-filter: blur(8px);
            transition: opacity 0.3s; z-index: 100;
        }

        .panel {
            background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid #444;
            box-shadow: 0 0 60px rgba(0,0,0,0.9); max-width: 1000px; width: 90%; position: relative;
            max-height: 90vh; overflow-y: auto;
        }

        /* === MENU JUKEBOX === */
        .jukebox { display: flex; gap: 30px; height: 450px; width: 100%; flex-wrap: wrap; }
        .song-col { flex: 1; display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding-right: 10px; min-width: 300px; }
        .song-item {
            background: #1a1a1a; padding: 15px; border-radius: 10px; border-left: 5px solid #333;
            cursor: pointer; transition: 0.2s; display: flex; justify-content: space-between; align-items: center;
        }
        .song-item:hover { background: #252525; transform: translateX(5px); }
        .song-item.selected { border-left-color: var(--c1); background: linear-gradient(90deg, #222, #111); box-shadow: inset 0 0 20px rgba(0,255,255,0.1); }
        .song-item.missing { border-left-color: var(--c3); border-style: dashed; opacity: 0.7; }

        .visual-col { 
            flex: 1; background: radial-gradient(circle, #222, #000); border-radius: 15px; border: 1px solid #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; min-width: 300px;
        }
        
        /* === BOTONES & INPUTS === */
        button { 
            padding: 15px; width: 100%; font-family: inherit; font-size: 1.1rem; cursor: pointer;
            border: none; background: white; color: black; font-weight: 900; text-transform: uppercase;
            border-radius: 8px; transform: skew(-10deg); transition: 0.2s; box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
        }
        button:hover { background: var(--c1); transform: scale(1.05) skew(-10deg); box-shadow: 0 0 20px var(--c1); }
        button.secondary { background: #333; color: white; border: 1px solid #555; }
        button:disabled { background: #444; opacity: 0.5; cursor: default; transform: skew(-10deg); box-shadow: none; }

        /* Bot√≥n Custom para Background */
        .btn-bg-upload {
            background: #222; border: 1px dashed #666; color: #aaa; padding: 10px; text-align: center;
            border-radius: 8px; margin-top: 10px; cursor: pointer; font-size: 0.9rem; transition: 0.2s;
        }
        .btn-bg-upload:hover { border-color: var(--c1); color: white; background: #333; }

        input[type="file"] { display: none; }
        input.login-input { width: 100%; padding: 12px; background: #000; border: 1px solid #444; color: white; border-radius: 5px; margin-bottom: 10px; text-align: center; font-size: 1.1rem; }

        /* === GAMEPLAY & SHAPES === */
        #track { 
            position: relative; width: 100%; max-width: 600px; height: 100%; margin: 0 auto; 
            border-left: 2px solid rgba(255,255,255,0.1); border-right: 2px solid rgba(255,255,255,0.1); 
            background: linear-gradient(to bottom, transparent, rgba(255,255,255,0.05));
        }

        .arrow-wrapper { position: absolute; width: 25%; height: 100px; display: flex; align-items: center; justify-content: center; will-change: transform; z-index: 10; }
        .arrow-svg { width: 85px; height: 85px; transition: transform 0.05s; }
        .arrow-path { stroke: white; stroke-width: 6; fill-opacity: 1; paint-order: stroke; }
        
        /* Formas Personalizables */
        .shape-circle .arrow-path { d: path("M 50, 10 a 40,40 0 1,0 0,80 a 40,40 0 1,0 0,-80"); }
        .shape-square .arrow-path { d: path("M 15,15 L 85,15 L 85,85 L 15,85 Z"); }
        .shape-diamond .arrow-path { d: path("M 50,5 L 95,50 L 50,95 L 5,50 Z"); }
        /* Flecha Default: path se mantiene en JS */

        .c-0 .arrow-path { fill: var(--c0); } .c-1 .arrow-path { fill: var(--c1); } 
        .c-2 .arrow-path { fill: var(--c2); } .c-3 .arrow-path { fill: var(--c3); }
        
        .sustain-trail { position: absolute; width: 30px; opacity: 0.6; z-index: -1; transform-origin: top center; background: currentColor; box-shadow: 0 0 15px currentColor; }
        .c-0.sustain-trail { color: var(--c0); } .c-1.sustain-trail { color: var(--c1); } .c-2.sustain-trail { color: var(--c2); } .c-3.sustain-trail { color: var(--c3); }

        .receptor { opacity: 0.5; z-index: 20; }
        .receptor .arrow-path { fill: rgba(0,0,0,0.2); stroke: #666; stroke-width: 4; filter: none; }
        .receptor.pressed { opacity: 1; transform: scale(0.9); }
        .receptor.pressed .arrow-path { fill: currentColor; stroke: white; filter: drop-shadow(0 0 20px currentColor); }

        /* HUD */
        #hud { position: absolute; width: 250px; top: 50%; right: 20px; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .score-big { font-size: 3rem; font-weight: 900; margin-bottom: 5px; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        #live-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 100%; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); backdrop-filter: blur(5px); }
        .stat-mini { display: flex; flex-direction: column; align-items: center; font-weight: bold; }
        
        #health-container { width: 30px; height: 400px; background: #000; border: 2px solid white; border-radius: 15px; overflow: hidden; margin-top: 20px; position: relative; }
        #health-fill { width: 100%; height: 50%; background: linear-gradient(0deg, #F00 0%, #FF0 50%, #0F0 100%); position: absolute; bottom: 0; transition: height 0.1s linear; }

        /* EFECTOS Y CONFIG */
        .rating { position: absolute; left: 50%; top: 40%; transform: translate(-50%, -50%); font-size: 5rem; font-weight: 900; -webkit-text-stroke: 3px black; animation: popUp 0.35s forwards; z-index: 100; pointer-events: none; }
        @keyframes popUp { 0% { transform: translate(-50%, -40%) scale(0.8); opacity: 0; } 100% { transform: translate(-50%, -60%) scale(1.2); opacity: 0; } }
        
        .particle { position: fixed; width: 12px; height: 12px; border-radius: 50%; z-index: 90; animation: burst 0.5s ease-out forwards; pointer-events: none; }
        @keyframes burst { 0% { transform: translate(0,0) scale(1); opacity: 1; } 100% { transform: translate(var(--vx), var(--vy)) scale(0); opacity: 0; } }
        .bump { transform: scale(1.02); }

        /* AJUSTES */
        .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; text-align: left; }
        .setting-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; color: #ccc; }
        input[type="range"] { width: 50%; accent-color: var(--c1); }
        input[type="checkbox"] { transform: scale(1.5); accent-color: var(--c1); }
        input[type="color"] { border:none; width:40px; height:30px; background:none; cursor:pointer; }
        select { background: #222; color: white; border: 1px solid #444; padding: 5px; border-radius: 5px; }

        .key-box { width: 50px; height: 50px; background: #000; border: 2px solid #555; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .key-box.listening { border-color: var(--c2); color: var(--c2); animation: pulse 0.5s infinite; border-width: 3px; }
        @keyframes pulse { 0% { opacity: 0.5; } 100% { opacity: 1; } }

        #countdown-layer { position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 200; }
        .count-num { font-size: 10rem; font-weight: 900; -webkit-text-stroke: 4px black; animation: countPop 0.5s forwards; filter: drop-shadow(0 0 20px white); }
        @keyframes countPop { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 0; } }

        /* Mobile Controls */
        #mobile-controls { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; }
        .touch-zone { position: absolute; height: 100%; width: 25%; border-right: 1px solid rgba(255,255,255,0.05); }
        .touch-zone:active { background: rgba(255,255,255,0.1); }
    </style>
</head>
<body>

    <div id="bg-layer">
        <video id="bg-video" loop muted playsinline class="hidden"></video>
        <img id="bg-image" class="hidden">
    </div>

    <div id="user-bar" onclick="toggleLogin()">
        <div class="avatar" id="u-av">G</div>
        <div class="user-info">
            <div class="user-name" id="u-name">Guest</div>
            <div class="user-lvl">LVL <span id="u-lvl">1</span></div>
            <div class="xp-track"><div class="xp-fill" id="u-xp"></div></div>
        </div>
    </div>

    <div id="login-modal" class="screen hidden" style="z-index: 10000;">
        <div class="panel" style="max-width: 400px; text-align: center;">
            <h2 style="color:var(--c1)">CUENTA</h2>
            <div id="login-view">
                <input type="text" id="log-user" class="login-input" placeholder="Usuario">
                <input type="password" id="log-pass" class="login-input" placeholder="Contrase√±a">
                <button onclick="login()">INICIAR SESI√ìN</button>
                <button class="secondary" style="margin-top:10px" onclick="register()">REGISTRAR</button>
            </div>
            <div id="user-view" class="hidden">
                <h3 id="logged-user" style="color:var(--c1)"></h3>
                <button onclick="saveCloud()">GUARDAR PROGRESO</button>
                <button class="secondary" style="margin-top:10px" onclick="logout()">CERRAR SESI√ìN</button>
            </div>
            <button class="secondary" style="margin-top:20px" onclick="document.getElementById('login-modal').classList.add('hidden')">CERRAR</button>
        </div>
    </div>

    <div id="menu-screen" class="screen">
        <h1 style="text-shadow:0 0 30px var(--c1); font-size:4rem; margin-bottom:20px;">A NOTE GAME</h1>
        
        <div class="panel">
            <div class="jukebox">
                <div class="song-col">
                    <label class="song-item" style="border-left-color:var(--c2); background:rgba(0,255,0,0.1); justify-content:center;">
                        <span style="font-weight:bold;">+ IMPORTAR MP3</span>
                        <input type="file" id="audio-in" accept="audio/*" onchange="handleAudio(this)">
                    </label>
                    <label class="btn-bg-upload">
                        üñºÔ∏è FONDO (IMG/VIDEO)
                        <input type="file" id="bg-in" accept="image/*,video/*" onchange="handleBg(this)">
                    </label>
                    <div id="song-list" style="margin-top:15px;"></div>
                </div>
                
                <div class="visual-col">
                    <h2 id="sel-title" style="color:var(--c1); text-align:center; margin-top:20px;">Selecciona...</h2>
                    <div id="sel-stats" style="text-align:center; opacity:0;">
                        <div style="color:#888; font-size:0.8rem;">R√âCORD</div>
                        <div style="font-size:2.5rem; font-weight:bold;" id="sel-score">0</div>
                        <div style="font-size:1.5rem; font-weight:bold; color:var(--gold);" id="sel-rank">RANK ?</div>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button id="btn-play" disabled onclick="prepareGame()">JUGAR</button>
                <button class="secondary" onclick="openSettings()">AJUSTES</button>
            </div>
            <p id="loader" style="color:var(--c1); text-align:center; display:none; margin-top:10px; font-weight:bold;">ANALIZANDO...</p>
        </div>
    </div>

    <div id="settings-screen" class="screen hidden">
        <div class="panel" style="max-width: 800px;">
            <h2>AJUSTES</h2>
            <div class="settings-grid">
                <div>
                    <h3 style="color:var(--c1); border-bottom:1px solid #333;">JUEGO</h3>
                    <div class="setting-row"><span>Downscroll</span><input type="checkbox" id="set-down"></div>
                    <div class="setting-row"><span>Velocidad</span><input type="range" id="set-spd" min="5" max="30" oninput="updDisp()"></div>
                    <div class="setting-row"><span>Dificultad</span><input type="range" id="set-den" min="1" max="10" oninput="updDisp()"></div>
                    <div class="setting-row"><span>Forma de Notas</span>
                        <select id="set-shape">
                            <option value="arrow">Flechas</option>
                            <option value="circle">C√≠rculos</option>
                            <option value="square">Cuadrados</option>
                            <option value="diamond">Diamantes</option>
                        </select>
                    </div>
                </div>
                <div>
                    <h3 style="color:var(--c2); border-bottom:1px solid #333;">EFECTOS & TECLAS</h3>
                    <div class="setting-row"><span>Bloom (Brillo)</span><input type="checkbox" id="set-bloom"></div>
                    <div class="setting-row"><span>Part√≠culas</span><input type="checkbox" id="set-part"></div>
                    <div class="setting-row"><span>C√°mara</span><input type="checkbox" id="set-cam"></div>
                    
                    <div style="margin-top:10px;">
                        <div style="display:flex; gap:5px; justify-content:center;">
                            <input type="color" id="col-0"><input type="color" id="col-1"><input type="color" id="col-2"><input type="color" id="col-3">
                        </div>
                    </div>
                    <div class="key-box-row" style="display:flex; gap:10px; justify-content:center; margin-top:10px;">
                        <div class="key-box" id="k0" onclick="remap(0)">A</div>
                        <div class="key-box" id="k1" onclick="remap(1)">S</div>
                        <div class="key-box" id="k2" onclick="remap(2)">W</div>
                        <div class="key-box" id="k3" onclick="remap(3)">D</div>
                    </div>
                </div>
            </div>
            <button onclick="saveSettings()" style="margin-top:20px;">GUARDAR Y SALIR</button>
        </div>
    </div>

    <div id="game-layer"><div id="track"></div></div>
    
    <div id="ui-layer">
        <div id="hud" class="hidden">
            <div style="font-size:0.8rem; color:#aaa;">SCORE</div>
            <div class="score-big" id="g-score">0</div>
            
            <div id="live-stats">
                <div class="stat-mini" style="color:var(--c1)">SICK <span id="g-sick">0</span></div>
                <div class="stat-mini" style="color:var(--c2)">GOOD <span id="g-good">0</span></div>
                <div class="stat-mini" style="color:yellow">BAD <span id="g-bad">0</span></div>
                <div class="stat-mini" style="color:var(--c3)">MISS <span id="g-miss">0</span></div>
            </div>
            
            <div style="display:flex; gap:15px; height:300px; align-items:center; margin-top:20px;">
                <div id="health-container">
                    <div id="health-fill"></div>
                </div>
                <div style="font-weight:900; font-size:1.5rem; writing-mode:vertical-rl; text-orientation:mixed; color:var(--c1);">COMBO: <span id="g-combo">0</span></div>
            </div>
        </div>
    </div>
    <div id="countdown-layer"></div>

    <div id="result-screen" class="screen hidden">
        <div class="panel" style="max-width:500px; text-align:center;">
            <h1>FIN</h1>
            <h2 id="res-rank" style="font-size:6rem; margin:0;">A</h2>
            <div id="fc-text" style="color:var(--gold); display:none; font-weight:bold;">‚òÖ FULL COMBO ‚òÖ</div>
            <div style="color:#aaa;">+<span id="res-xp">0</span> XP</div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:20px 0; font-size:1.2rem;">
                <div>SICK: <span id="r-sick" style="color:var(--c1)">0</span></div>
                <div>GOOD: <span id="r-good" style="color:var(--c2)">0</span></div>
                <div>BAD: <span id="r-bad" style="color:yellow">0</span></div>
                <div>MISS: <span id="r-miss" style="color:var(--c3)">0</span></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button onclick="prepareGame()">REINTENTAR</button>
                <button class="secondary" onclick="toMenu()">MEN√ö</button>
            </div>
        </div>
    </div>

    <div id="mobile-controls" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; z-index:90;">
        <div class="touch-zone" style="position:absolute; height:100%; width:25%; left:0%; border-right:1px solid rgba(255,255,255,0.1);" data-l="0"></div>
        <div class="touch-zone" style="position:absolute; height:100%; width:25%; left:25%; border-right:1px solid rgba(255,255,255,0.1);" data-l="1"></div>
        <div class="touch-zone" style="position:absolute; height:100%; width:25%; left:50%; border-right:1px solid rgba(255,255,255,0.1);" data-l="2"></div>
        <div class="touch-zone" style="position:absolute; height:100%; width:25%; left:75%;" data-l="3"></div>
    </div>

    <script>
        /* === CORE STATE === */
        let cfg = { 
            keys:['a','s','w','d'], down:false, spd:12, den:5, 
            bloom:true, part:true, cam:true, shape:'arrow',
            cols:['#C24B99','#00FFFF','#12FA05','#F9393F'] 
        };
        let user = { name:"Guest", pass:"", xp:0, lvl:1, songs:[], scores:{} }; 
        let ramSongs = []; 
        let curIdx = -1;
        
        const st = { 
            act:false, ctx:new (window.AudioContext||window.webkitAudioContext)(), src:null, t0:0, 
            notes:[], spawned:[], keys:[0,0,0,0], 
            sc:0, cmb:0, hp:50, stats:{s:0,g:0,b:0,m:0} 
        };
        const paths = {
            arrow: "M 20 20 L 50 50 L 80 20 L 80 40 L 50 70 L 20 40 Z",
            circle: "M 50, 10 a 40,40 0 1,0 0,80 a 40,40 0 1,0 0,-80",
            square: "M 15,15 L 85,15 L 85,85 L 15,85 Z",
            diamond: "M 50,5 L 95,50 L 50,95 L 5,50 Z"
        };

        init();

        function init() {
            loadCfg(); loadUser(); updUserUI(); renderList(); checkMobile();
        }

        /* === USER SYSTEM === */
        function loadUser() {
            const last = localStorage.getItem('fnf_last');
            if(last) { const d = localStorage.getItem('fnf_u_'+last); if(d) user = JSON.parse(d); }
            if(!user.songs) user.songs = []; if(!user.scores) user.scores = {};
            if(typeof user.xp === 'undefined') user.xp=0; if(typeof user.lvl === 'undefined') user.lvl=1;
        }
        function saveUser() { if(user.name!=="Guest") localStorage.setItem('fnf_u_'+user.name, JSON.stringify(user)); }
        function saveCloud() { saveUser(); alert("¬°Guardado!"); }
        
        function toggleLogin() { 
            document.getElementById('login-modal').classList.remove('hidden'); 
            const isLog = user.name !== "Guest";
            document.getElementById('login-view').style.display = isLog ? 'none' : 'block';
            document.getElementById('user-view').classList.toggle('hidden', !isLog);
            if(isLog) document.getElementById('logged-user').innerText = user.name;
        }
        function login() {
            const n=document.getElementById('log-user').value; const p=document.getElementById('log-pass').value;
            const d=localStorage.getItem('fnf_u_'+n);
            if(d) {
                const u = JSON.parse(d);
                if(u.pass === p) { user=u; localStorage.setItem('fnf_last',n); loadUser(); updUserUI(); renderList(); document.getElementById('login-modal').classList.add('hidden'); }
                else alert("Contrase√±a incorrecta");
            } else alert("Usuario no existe");
        }
        function register() {
            const n=document.getElementById('log-user').value; const p=document.getElementById('log-pass').value;
            if(!n||!p)return alert("Llena todo");
            if(localStorage.getItem('fnf_u_'+n)) return alert("Ya existe");
            user = { name:n, pass:p, xp:0, lvl:1, songs:[], scores:{} };
            localStorage.setItem('fnf_last',n); saveUser(); updUserUI(); renderList(); document.getElementById('login-modal').classList.add('hidden');
        }
        function logout() {
            localStorage.removeItem('fnf_last'); user={name:"Guest",xp:0,lvl:1,songs:[],scores:{}};
            updUserUI(); renderList(); document.getElementById('login-modal').classList.add('hidden');
        }
        function updUserUI() {
            document.getElementById('u-name').innerText=user.name;
            document.getElementById('u-lvl').innerText=user.lvl;
            document.getElementById('u-av').innerText=user.name[0].toUpperCase();
            document.getElementById('u-xp').style.width = (user.xp/(user.lvl*1000)*100)+'%';
        }

        /* === BACKGROUND & FILES === */
        function handleBg(inpt) {
            if(!inpt.files[0]) return;
            const f = inpt.files[0];
            const url = URL.createObjectURL(f);
            
            if(f.type.startsWith('video')) {
                const v = document.getElementById('bg-video');
                v.src = url; v.classList.remove('hidden'); v.play();
                document.getElementById('bg-image').classList.add('hidden');
                // Extract audio from video for map gen if needed? No, user usually uploads separate MP3 for game audio.
                // If they want video BG + video Audio, they should upload MP3 of video first.
            } else {
                const i = document.getElementById('bg-image');
                i.src = url; i.classList.remove('hidden');
                document.getElementById('bg-video').classList.add('hidden');
            }
        }

        async function handleAudio(inpt) {
            if(!inpt.files[0]) return;
            const f = inpt.files[0];
            const name = f.name.replace(/\.[^/.]+$/, "");
            document.getElementById('loader').style.display='block';
            try {
                const buf = await f.arrayBuffer();
                const aud = await st.ctx.decodeAudioData(buf);
                const map = genMap(aud);
                
                const obj = { id:name, buf:aud, map:map };
                const ex = ramSongs.findIndex(x=>x.id===name);
                if(ex!==-1) ramSongs[ex]=obj; else ramSongs.push(obj);
                
                if(!user.songs.includes(name)) { user.songs.push(name); saveUser(); }
                renderList(); selSong(name);
            } catch(e) { alert("Error: "+e); }
            document.getElementById('loader').style.display='none';
            inpt.value='';
        }

        function renderList() {
            const l = document.getElementById('song-list'); l.innerHTML='';
            user.songs.forEach(name => {
                const hasRam = ramSongs.find(x=>x.id===name);
                const sc = user.scores[name];
                const el = document.createElement('div');
                el.className = 'song-item ' + (curIdx===name?'selected':'') + (hasRam?'':' missing');
                el.innerHTML = `<div><div style="font-weight:bold">${name}</div><div style="font-size:0.8rem;color:#666">${hasRam?'LISTO':'‚ö†Ô∏è RECARGAR'}</div></div> ${sc?`<b style="color:var(--gold)">${sc.r}</b>`:''}`;
                el.onclick = () => { if(hasRam) selSong(name); else document.getElementById('audio-in').click(); };
                l.appendChild(el);
            });
        }

        function selSong(name) {
            curIdx = name; renderList();
            const s = ramSongs.find(x=>x.id===name);
            document.getElementById('sel-title').innerText = name;
            document.getElementById('btn-play').disabled = false;
            
            const sc = user.scores[name];
            document.getElementById('sel-stats').style.opacity = sc?'1':'0';
            if(sc) { document.getElementById('sel-score').innerText=sc.s; document.getElementById('sel-rank').innerText="RANK "+sc.r; }

            if(st.src) try{st.src.stop()}catch(e){}
            const src = st.ctx.createBufferSource();
            src.buffer = s.buf; src.connect(st.ctx.destination);
            src.loop = true; src.start(0, s.buf.duration/3);
            st.src = src;
        }

        function genMap(buf) {
            const d = buf.getChannelData(0); const map=[];
            const step = Math.floor(buf.sampleRate/60);
            let lastT=-1000; let lastL=0; const th = 1.6-(cfg.den*0.08);
            let hist=[];
            
            for(let i=0; i<d.length; i+=step) {
                let sum=0; for(let j=0; j<step && i+j<d.length; j++) sum+=d[i+j]**2;
                const rms = Math.sqrt(sum/step);
                hist.push(rms); if(hist.length>40)hist.shift();
                const avg = hist.reduce((a,b)=>a+b,0)/hist.length;
                
                if(rms > avg*th && rms > 0.02) {
                    const t = (i/buf.sampleRate)*1000;
                    if(t-lastT > (400-cfg.den*30)) {
                        let l = Math.floor(Math.random()*4);
                        if(l===lastL && Math.random()>0.3) l=(l+1)%4;
                        let dur = (rms>avg*1.5 && Math.random()>0.6) ? Math.random()*300+100 : 0;
                        map.push({t:t, l:l, d:dur, h:false});
                        lastT=t; lastL=l;
                    }
                }
            }
            return map;
        }

        /* === GAME === */
        function prepareGame() {
            if(st.src) try{st.src.stop()}catch(e){}
            const v = document.getElementById('bg-video'); if(!v.classList.contains('hidden')) { v.currentTime=0; v.play(); }
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('ui-layer').classList.remove('hidden');
            document.getElementById('hud').classList.remove('hidden');
            
            const s = ramSongs.find(x=>x.id===curIdx);
            st.notes = JSON.parse(JSON.stringify(s.map));
            st.spawned = []; st.sc=0; st.cmb=0; st.hp=50; st.stats={s:0,g:0,b:0,m:0};
            st.keys = [0,0,0,0];
            
            const t = document.getElementById('track'); t.innerHTML='';
            const y = cfg.down ? window.innerHeight-140 : 80;
            const p = paths[cfg.shape]; // CUSTOM SHAPE
            
            for(let i=0;i<4;i++){
                const r=document.createElement('div');
                r.className=`arrow-wrapper receptor c-${i}`; r.id=`rec-${i}`;
                r.style.left=(i*25)+'%'; r.style.top=y+'px';
                r.innerHTML=`<div class="arrow-svg"><svg viewBox="0 0 100 100" style="width:100%;height:100%"><path class="arrow-path" d="${p}"/></svg></div>`;
                t.appendChild(r);
            }
            updHUD();

            const l = document.getElementById('countdown-layer');
            let c=3; l.innerHTML=`<div class="count-num">3</div>`;
            const iv = setInterval(()=>{
                c--; if(c>0) l.innerHTML=`<div class="count-num">${c}</div>`;
                else if(c===0) l.innerHTML=`<div class="count-num" style="color:var(--c1)">GO!</div>`;
                else { clearInterval(iv); l.innerHTML=''; run(); }
            },600);
        }

        function run() {
            st.act = true;
            const s = ramSongs.find(x=>x.id===curIdx);
            st.src = st.ctx.createBufferSource();
            st.src.buffer = s.buf; st.src.connect(st.ctx.destination);
            st.t0 = st.ctx.currentTime + 0.05; 
            st.src.start(st.t0);
            st.src.onended = () => end(false);
            loop();
        }

        function loop() {
            if(!st.act) return;
            const now = (st.ctx.currentTime - st.t0)*1000;
            const yHit = cfg.down ? window.innerHeight-140 : 80;
            const p = paths[cfg.shape];

            // Spawn
            for(let i=0; i<st.notes.length; i++) {
                const n = st.notes[i];
                if(n.s) continue;
                if(n.t < now-200) { n.s=true; continue; }
                if(n.t - now < 1500) {
                    const el = document.createElement('div');
                    el.className = `arrow-wrapper c-${n.l}`;
                    el.style.left = (n.l*25)+'%';
                    el.style.zIndex = 5;
                    el.innerHTML = `<div class="arrow-svg"><svg viewBox="0 0 100 100" style="width:100%;height:100%"><path class="arrow-path" d="${p}"/></svg></div>`;
                    
                    if(n.d>0) {
                        const tr = document.createElement('div'); tr.className=`sustain-trail c-${n.l}`;
                        const h = (n.d/1000)*cfg.spd*60;
                        tr.style.height=h+'px';
                        if(cfg.down){tr.style.bottom='50%'; tr.style.transformOrigin='bottom center';}
                        else{tr.style.top='50%'; tr.style.transformOrigin='top center';}
                        el.appendChild(tr);
                    }
                    if(cfg.bloom) el.querySelector('.arrow-path').style.filter=`drop-shadow(0 0 8px ${cfg.cols[n.l]})`;
                    
                    document.getElementById('track').appendChild(el);
                    n.el = el; st.spawned.push(n); n.s = true;
                } else break;
            }

            // Move
            for(let i=st.spawned.length-1; i>=0; i--) {
                const n = st.spawned[i];
                const diff = n.t - now;

                if(n.h && n.d>0) {
                    n.el.style.top = yHit+'px'; n.el.style.opacity=0.5;
                    const rem = (n.t+n.d)-now;
                    if(rem <= 0) { if(n.el&&n.el.parentNode)n.el.remove(); st.spawned.splice(i,1); continue; }
                    
                    const tr = n.el.querySelector('.sustain-trail');
                    if(tr) tr.style.height = Math.max(0, (rem/1000)*cfg.spd*60)+'px';
                    if(st.keys[n.l]) updHp(0.05); else n.el.style.opacity=0.2;

                } else if(!n.h) {
                    const py = (diff/1000)*cfg.spd*60;
                    n.el.style.top = (cfg.down ? yHit-py : yHit+py) + 'px';
                    if(diff < -160) { miss(n); n.h=true; n.el.style.opacity=0.4; setTimeout(()=>n.el?.remove(),200); st.spawned.splice(i,1); }
                } else {
                    if(n.el&&n.el.parentNode)n.el.remove();
                    st.spawned.splice(i,1);
                }
            }
            requestAnimationFrame(loop);
        }

        /* === INPUT === */
        window.onkeydown = e => { if(!e.repeat && remapIdx===null && cfg.keys.includes(e.key)) hit(cfg.keys.indexOf(e.key), true); };
        window.onkeyup = e => { if(remapIdx===null && cfg.keys.includes(e.key)) hit(cfg.keys.indexOf(e.key), false); };
        document.querySelectorAll('.touch-zone').forEach(z => {
            z.ontouchstart = e => { e.preventDefault(); hit(parseInt(z.dataset.l), true); };
            z.ontouchend = e => { e.preventDefault(); hit(parseInt(z.dataset.l), false); };
        });

        function hit(l, p) {
            if(!st.act) return;
            const r = document.getElementById(`rec-${l}`);
            if(p) {
                st.keys[l] = 1; r.classList.add('pressed');
                const now = (st.ctx.currentTime-st.t0)*1000;
                const n = st.spawned.find(x => x.l===l && !x.h && Math.abs(x.t-now)<160);
                
                if(n) {
                    n.h = true; const d = Math.abs(n.t-now);
                    let txt="BAD", c="yellow", pts=50;
                    if(d<45) { txt="SICK"; c="var(--c1)"; pts=350; st.stats.s++; if(cfg.part) pop(l); if(cfg.cam) bump(); }
                    else if(d<90) { txt="GOOD"; c="var(--c2)"; pts=200; st.stats.g++; }
                    else { st.stats.b++; st.cmb=0; updHp(-5); }
                    
                    if(pts>50) st.cmb++; if(st.cmb>st.sc) st.maxCombo=st.cmb;
                    st.sc+=pts; updHp(2); show(txt,c); updHUD();
                    if(n.d<=0 && n.el) n.el.style.display='none';
                } else { st.sc-=10; updHUD(); }
            } else {
                st.keys[l] = 0; r.classList.remove('pressed');
            }
        }

        function miss(n) { show("MISS", "var(--c3)"); st.stats.m++; st.cmb=0; updHp(-10); updHUD(); }
        function updHp(v) { st.hp+=v; if(st.hp>100)st.hp=100; if(st.hp<=0)end(true); document.getElementById('health-fill').style.height = `${st.hp}%`; }
        function updHUD() {
            document.getElementById('g-score').innerText = st.sc;
            document.getElementById('g-combo').innerText = st.cmb;
            document.getElementById('g-sick').innerText = st.stats.s;
            document.getElementById('g-good').innerText = st.stats.g;
            document.getElementById('g-bad').innerText = st.stats.b;
            document.getElementById('g-miss').innerText = st.stats.m;
        }
        function show(t,c) {
            const e=document.createElement('div'); e.className='rating'; e.innerText=t; e.style.color=c; e.style.textShadow=`0 0 10px ${c}`;
            document.body.appendChild(e); setTimeout(()=>e.remove(),400);
        }
        function pop(l) {
            const r=document.getElementById(`rec-${l}`).getBoundingClientRect();
            for(let i=0;i<5;i++){
                const p=document.createElement('div'); p.className='particle'; p.style.background=cfg.cols[l];
                p.style.left=(r.left+45)+'px'; p.style.top=(r.top+45)+'px';
                const a=Math.random()*6.28, s=Math.random()*100+50;
                p.style.setProperty('--vx', Math.cos(a)*s+'px'); p.style.setProperty('--vy', Math.sin(a)*s+'px');
                document.body.appendChild(p); setTimeout(()=>p.remove(),500);
            }
        }
        function bump(){ const l=document.getElementById('game-layer'); l.classList.remove('bump'); void l.offsetWidth; l.classList.add('bump'); setTimeout(()=>l.classList.remove('bump'),100); }

        function end(died) {
            st.act = false; if(st.src) try{st.src.stop()}catch(e){}
            const v = document.getElementById('bg-video'); if(!v.classList.contains('hidden')) v.pause();
            
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('r-sick').innerText = st.stats.s;
            document.getElementById('r-good').innerText = st.stats.g;
            document.getElementById('r-bad').innerText = st.stats.b;
            document.getElementById('r-miss').innerText = st.stats.m;
            
            if(died) { document.getElementById('res-rank').innerText = "F"; document.getElementById('res-rank').style.color = "red"; }
            else {
                const tot = st.stats.s+st.stats.g+st.stats.b+st.stats.m;
                const acc = tot>0 ? (st.stats.s + st.stats.g*0.5)/tot : 0;
                let r="C"; if(acc>0.8)r="B"; if(acc>0.9)r="A"; if(acc>0.95)r="S";
                const el=document.getElementById('res-rank'); el.innerText=r; 
                el.style.color=r==='S'?'var(--gold)':(r==='A'?'var(--c2)':'var(--c1)');
                if(st.stats.m===0) document.getElementById('fc-text').style.display='block';
                
                if(user.name!=="Guest") {
                    const xp = Math.floor(st.sc/100);
                    document.getElementById('res-xp').innerText = xp;
                    user.xp+=xp; if(user.xp>=user.lvl*1000){ user.xp=0; user.lvl++; }
                    const old = user.scores[curIdx];
                    if(!old || st.sc>old.s) user.scores[curIdx] = {s:st.sc, r:r};
                    saveUser(); updUserUI();
                }
            }
        }
        function toMenu() {
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
            document.getElementById('track').innerHTML = '';
            document.getElementById('disc-visual').classList.remove('spin');
            renderList();
        }

        /* === CONFIG === */
        function loadCfg() { const s=localStorage.getItem('fnf_v6_cfg'); if(s) cfg={...cfg,...JSON.parse(s)}; applyCfg(); }
        function openSettings(){ 
            document.getElementById('menu-screen').classList.add('hidden'); 
            document.getElementById('settings-screen').classList.remove('hidden');
            document.getElementById('set-down').checked=cfg.down; 
            document.getElementById('set-spd').value=cfg.spd; 
            document.getElementById('set-den').value=cfg.den; 
            document.getElementById('set-bloom').checked=cfg.bloom; 
            document.getElementById('set-part').checked=cfg.part; 
            document.getElementById('set-cam').checked=cfg.cam; 
            document.getElementById('set-shape').value=cfg.shape;
            for(let i=0;i<4;i++) {
                document.getElementById(`col-${i}`).value = cfg.cols[i];
                document.getElementById(`k${i}`).innerText=cfg.keys[i].toUpperCase();
            }
            updDisp(); 
        }
        function updDisp(){ document.getElementById('d-spd').innerText=document.getElementById('set-spd').value; document.getElementById('d-den').innerText=document.getElementById('set-den').value; }
        
        function saveSettings(){ 
            cfg.down=document.getElementById('set-down').checked; 
            cfg.spd=parseInt(document.getElementById('set-spd').value); 
            cfg.den=parseInt(document.getElementById('set-den').value); 
            cfg.bloom=document.getElementById('set-bloom').checked; 
            cfg.part=document.getElementById('set-part').checked; 
            cfg.cam=document.getElementById('set-cam').checked;
            cfg.shape=document.getElementById('set-shape').value;
            for(let i=0;i<4;i++) cfg.cols[i] = document.getElementById(`col-${i}`).value;
            
            localStorage.setItem('fnf_v6_cfg',JSON.stringify(cfg)); 
            applyCfg();
            document.getElementById('settings-screen').classList.add('hidden'); 
            document.getElementById('menu-screen').classList.remove('hidden'); 
        }
        
        function applyCfg() {
            document.documentElement.style.setProperty('--c0', cfg.cols[0]);
            document.documentElement.style.setProperty('--c1', cfg.cols[1]);
            document.documentElement.style.setProperty('--c2', cfg.cols[2]);
            document.documentElement.style.setProperty('--c3', cfg.cols[3]);
        }
        function checkMobile() {
            if(/Android|iPhone|iPad/i.test(navigator.userAgent)) {
                document.getElementById('mobile-controls').style.display='block';
                cfg.bloom = false;
            }
        }

        let remapIdx=null; 
        function remap(i){remapIdx=i; document.getElementById(`k${i}`).classList.add('listening'); document.getElementById(`k${i}`).innerText="?";}
        document.addEventListener('keydown', e=>{if(remapIdx!==null){cfg.keys[remapIdx]=e.key.toLowerCase(); document.getElementById(`k${remapIdx}`).innerText=e.key.toUpperCase(); document.getElementById(`k${remapIdx}`).classList.remove('listening'); remapIdx=null;}});
    </script>
</body>
</html>